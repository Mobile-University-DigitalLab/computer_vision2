---
title: "R Notebook"
output: html_notebook
---

 1. Vorbereitungen
ðŸ“¥ Lade den Datensatz von Kaggle:
https://www.kaggle.com/datasets/paultimothymooney/blood-cells

Entpacke den Unterordner dataset2-master des ZIP-Archivs lokal z. B. nach:
"E:/bloodcelldata/dataset2-master/images"

```{r}
library(torch)
library(magick)
library(ggplot2)

base_path <- "E:/bloodcelldata/dataset2-master/images"

# Daten laden
load_image_paths <- function(dir) {
  classes <- list.dirs(dir, full.names = FALSE, recursive = FALSE)
  paths <- c(); labels <- c()
  for (i in seq_along(classes)) {
    f <- list.files(file.path(dir, classes[i]), pattern = "\\.(jpg|jpeg|png)$", full.names = TRUE, ignore.case = TRUE)
    paths <- c(paths, f)
    labels <- c(labels, rep(i - 1, length(f)))
  }
  list(paths = paths, labels = labels, class_names = classes)
}

# Dataset
BloodCellDataset <- dataset(
  initialize = function(paths, labels) {
    self$paths <- paths; self$labels <- labels
  },
  .getitem = function(i) {
    img <- image_read(self$paths[i]) |> image_resize("64x64!") |> image_data() |> as.numeric()
    d <- dim(img); img <- array(img, c(d[3], d[2], d[1]))
    list(x = torch_tensor(img / 255, dtype = torch_float()), y = torch_tensor(self$labels[i], dtype = torch_long()))
  },
  .length = function() length(self$paths)
)

# Visualisierung
show_image <- function(sample, class_names) {
  img <- as.array(sample$x$permute(c(2,3,1)))
  df <- as.data.frame(as.table(img)); names(df) <- c("x","y","c","v")
  ggplot(df, aes(x, y, fill=v)) + geom_raster() + facet_wrap(~c) +
    coord_fixed() + scale_fill_gradient(low="black", high="white") +
    theme_void() + ggtitle(class_names[sample$y$item()+1])
}

# Modell
SimpleCNN <- nn_module(
  initialize = function() {
    self$conv1 <- nn_conv2d(3, 16, 3, padding = 1)
    self$conv2 <- nn_conv2d(16, 32, 3, padding = 1)
    self$pool <- nn_max_pool2d(2)
    self$fc1 <- nn_linear(32 * 16 * 16, 64)
    self$fc2 <- nn_linear(64, 4)
  },
  forward = function(x) {
    x %>% self$conv1() %>% nnf_relu() %>% self$pool() %>%
      self$conv2() %>% nnf_relu() %>% self$pool() %>%
      (\(z) z$view(c(z$size(1), -1)))() %>%
      self$fc1() %>% nnf_relu() %>% self$fc2()
  }
)

# Hauptlauf
run <- function() {
  train <- load_image_paths(file.path(base_path, "TRAIN"))
  test  <- load_image_paths(file.path(base_path, "TEST"))
  ds_train <- BloodCellDataset(train$paths, train$labels)
  ds_test  <- BloodCellDataset(test$paths, test$labels)

  show_image(ds_train$.getitem(1), train$class_names)

  model <- SimpleCNN()
  opt <- optim_adam(model$parameters, lr=0.001)
  train_dl <- dataloader(ds_train, batch_size=32, shuffle=TRUE)
  model$train()
  coro::loop(for (b in train_dl) {
    opt$zero_grad()
    out <- model(b$x); loss <- nnf_cross_entropy(out, b$y)
    loss$backward(); opt$step()
  })

  model$eval()
  sample <- ds_test$.getitem(1)
  pred <- model(sample$x$unsqueeze(1))$argmax(dim=2)$item()
  cat("Vorhersage:", test$class_names[pred + 1], "\n")
}

run()
```

